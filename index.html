<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TL de Canto</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --gris-fondo: #242422;
      --gris-caja: #363632;
      --beige-texto: #ECE8D9;
      --amarillo-acento: #F7C873;
      --gris-hover: #45453c;
      --checker-bg: #29292e;
    }
html, body {
  min-height: 100dvh;
  margin: 0;
  padding: 0;
  font-family: 'IBM Plex Sans', 'Inter', Arial, sans-serif;
 background-color: #FFD200;
background: radial-gradient(circle, transparent 20%, #FFD200 20%, #FFD200 80%, transparent 80%, transparent), radial-gradient(circle, transparent 20%, #FFD200 20%, #FFD200 80%, transparent 80%, transparent) 25px 25px, linear-gradient(#000000 2px, transparent 2px) 0 -1px, linear-gradient(90deg, #000000 2px, #FFD200 2px) -1px 0;
background-size: 50px 50px, 50px 50px, 25px 25px, 25px 25px;
}

    body {
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      gap: 0;
    }
    .form-area {
      margin: 0 auto;
      width: 100%;
      max-width: 440px;
      background: var(--gris-caja);
      box-shadow: 0.38em 0.38em 0 0 var(--amarillo-acento);
      border-radius: 1px;
      padding: 2.2em 1.2em 1.2em 1.2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.4em;
    }
    .inputs {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1em;
      align-items: center;
    }
    input, textarea, select {
      width: 100%;
      font-family: inherit;
      font-size: 1.07em;
      padding: 0.8em 1em;
      border: none;
      border-radius: 1px;
      background: #2c2c27;
      color: var(--beige-texto);
      margin-bottom: 0.1em;
      outline: none;
      box-sizing: border-box;
      transition: background 0.17s;
    }
    input:focus, textarea:focus, select:focus {
      background: var(--gris-hover);
    }
    select {
      appearance: none;
      background: #2c2c27 url("data:image/svg+xml;utf8,<svg fill='white' height='16' viewBox='0 0 20 20' width='16' xmlns='http://www.w3.org/2000/svg'><path d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 011.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z'/></svg>") no-repeat right 1em center/1.2em 1.2em;
      color: var(--amarillo-acento);
      font-weight: bold;
      letter-spacing: .03em;
    }
    .botones {
      display: flex;
      gap: 1em;
      width: 100%;
      justify-content: center;
      margin-top: .2em;
      margin-bottom: .2em;
    }
    button {
      background: var(--amarillo-acento);
      color: var(--gris-fondo);
      font-family: inherit;
      border: none;
      border-radius: 1px;
      font-size: 1.09em;
      padding: 0.92em 2.9em;
      font-weight: bold;
      letter-spacing: 0.07em;
      box-shadow: 0.32em 0.32em 0 0 var(--azul-pat);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.7em;
      transition: background 0.16s, color 0.13s, box-shadow 0.17s, transform 0.2s;
      will-change: transform, box-shadow;
    }
    button:active, button[disabled] {
      background: #b6a547;
      color: #222;
    }
    button:hover:enabled {
      background: #d1ceac;
      color: var(--gris-caja);
      box-shadow: 0.5em 0.5em 0 0 var(--amarillo-acento);
    }
    .tl-area {
      width: 100vw;
      display: flex;
      justify-content: center;
      margin-top: 2.2em;
      margin-bottom: 1.7em;
    }
    .tl {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 1.6em;
      align-items: stretch;
    }
    .grabacion {
      background: var(--checker-bg);
      color: var(--beige-texto);
      border-radius: 0.7em;
      margin: 0 auto;
      padding: 1.2em 1.8em 1.2em 1.3em;
      box-shadow: 0 2px 15px #2224, 0.14em 0.14em 0 0 var(--amarillo-acento);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5em;
      font-size: 1.1em;
      border: none;
      position: relative;
    }
    .grabacion .tipo {
      position: absolute;
      right: 1.2em;
      top: 1.3em;
      font-size: .97em;
      color: var(--amarillo-acento);
      background: #242422bb;
      border-radius: 0.4em;
      padding: 0.18em 0.6em;
      font-weight: bold;
      letter-spacing: .01em;
      opacity: 0.95;
    }
    .grabacion .titulo {
      font-weight: bold;
      font-size: 1.17em;
      margin-bottom: .13em;
    }
    .grabacion .fecha {
      font-size: .95em;
      color: #beb9ab;
      margin-bottom: .10em;
      font-weight: 400;
    }
    .grabacion .comentario {
      color: var(--amarillo-acento);
      font-size: 1em;
      font-style: italic;
      margin-bottom: .11em;
      opacity: 0.97;
    }
    /* Audio custom player */
    .grabacion audio {
      width: 230px;
      height: 38px;
      margin: 0.5em auto 0.1em auto;
      background: var(--gris-caja);
      border-radius: 9px;
      box-shadow: 0 0 0 2.5px var(--amarillo-acento);
      outline: none;
      accent-color: var(--amarillo-acento);
      transition: box-shadow 0.19s;
    }
    audio::-webkit-media-controls-panel { background: var(--gris-caja); border-radius: 9px; }
    audio::-webkit-media-controls-play-button { filter: brightness(0.98) saturate(1.5) hue-rotate(15deg); }
    audio::-webkit-media-controls-current-time-display, audio::-webkit-media-controls-time-remaining-display {
      color: var(--amarillo-acento);
      font-family: inherit;
      font-size: 1em;
    }
    audio::-webkit-media-controls-timeline {
      background: var(--beige-texto);
      border-radius: 5px;
    }
    @media (max-width: 650px) {
      .form-area { max-width: 98vw; padding-left: 0.7em; }
      .tl { max-width: 99vw; }
      .grabacion { padding: 1.1em 0.6em 1em 0.5em; }
      .grabacion audio { width: 96vw; min-width: 120px; max-width: 97vw; }
    }
  </style>
</head>
<body>
  <div class="form-area">
    <div class="inputs">
      <input id="titulo" maxlength="64" placeholder="T√≠tulo..." autocomplete="off">
      <input id="comentario" maxlength="80" placeholder="Comentario (opcional)" autocomplete="off">
      <select id="tipo">
        <option value="">Tipo (opcional)</option>
        <option value="cover">Cover</option>
        <option value="improvisaci√≥n">Improvisaci√≥n</option>
        <option value="idea">Idea</option>
      </select>
    </div>
    <div class="botones">
      <button id="btn-grabar"><span>üéôÔ∏è</span><span>Grabar</span></button>
      <button id="btn-guardar" disabled><span>üíæ</span><span>Guardar</span></button>
    </div>
  </div>
  <div class="tl-area">
    <div class="tl" id="tl"></div>
  </div>
  <script>
const API = "http://localhost:5001/api";
const TL_AUDIO = "http://localhost:5001/mp3/";

    const $ = sel => document.querySelector(sel);

    let mediaRecorder, audioChunks = [], audioBlob = null;

    const btnGrabar = $('#btn-grabar');
    const btnGuardar = $('#btn-guardar');
    const tl = $('#tl');
    const tituloInput = $('#titulo');
    const comentarioInput = $('#comentario');
    const tipoInput = $('#tipo');

    document.addEventListener('DOMContentLoaded', mostrarTL);

    btnGrabar.addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        await iniciarGrabacion();
      } else if (mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        btnGrabar.querySelector('span:last-child').textContent = 'Grabar';
        btnGrabar.disabled = true;
      }
    });

    async function iniciarGrabacion() {
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstart = () => {
          btnGrabar.querySelector('span:last-child').textContent = 'Grabando...';
          btnGrabar.disabled = false;
          btnGuardar.disabled = true;
        };
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          btnGrabar.querySelector('span:last-child').textContent = 'Grabar';
          btnGrabar.disabled = false;
          btnGuardar.disabled = false;
        };
        mediaRecorder.start();
      } catch (err) {
        alert('No se pudo acceder al micro: ' + err.message);
      }
    }

    async function guardarGrabacion(audioBlob, titulo, comentario, tipo) {
      const formData = new FormData();
      formData.append("audio", audioBlob, "audio.webm");
      formData.append("titulo", titulo || "");
      formData.append("comentario", comentario || "");
      formData.append("tipo", tipo || "");
      const res = await fetch(`${API}/guardar`, {
        method: "POST",
        body: formData
      });
      if (!res.ok) {
        alert("Error al guardar la grabaci√≥n.");
        return false;
      }
      return true;
    }

    async function cargarTL() {
      const res = await fetch(`${API}/tl`);
      return await res.json();
    }

    btnGuardar.addEventListener('click', async () => {
      if (!audioBlob) return;
      const titulo = tituloInput.value.trim();
      const comentario = comentarioInput.value.trim();
      const tipo = tipoInput.value.trim();
      btnGuardar.disabled = true;
      btnGuardar.textContent = "Guardando...";
      const ok = await guardarGrabacion(audioBlob, titulo, comentario, tipo);
      btnGuardar.textContent = "üíæ Guardar";
      audioBlob = null;
      tituloInput.value = "";
      comentarioInput.value = "";
      tipoInput.value = "";
      if (ok) mostrarTL();
    });

    async function mostrarTL() {
      const tlArr = await cargarTL();
      tl.innerHTML = tlArr.length
        ? tlArr.map(g =>
          `<div class="grabacion">
            ${g.tipo ? `<div class="tipo">${g.tipo}</div>` : ''}
            ${g.titulo ? `<div class="titulo">${g.titulo}</div>` : ''}
            <div class="fecha">${toFecha(g.fecha)}</div>
            ${g.comentario ? `<div class="comentario">${g.comentario}</div>` : ''}
            <audio controls src="${TL_AUDIO}${g.filename}"></audio>
          </div>`
        ).join('')
        : '<div style="color:#444cf7;opacity:.7;text-align:center;padding:2em 0;">No hay grabaciones todav√≠a.</div>';
    }
    function toFecha(d) {
      const fecha = new Date(d);
      return fecha.toLocaleString('es-ES', {
        year: '2-digit', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    window.addEventListener('beforeunload', () => {
      audioBlob = null;
      btnGuardar.disabled = true;
    });
  </script>
</body>
</html>
